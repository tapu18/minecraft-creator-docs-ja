name: Create Translation Issues

on:
  push:
    branches: [main]
    paths:
      - "upstream/**"
      - "translation-assets/targets.yml"
      - "scripts/get-translate-target.py"
      - ".github/workflows/translation-issue-sync.yml"

permissions:
  contents: read
  issues: write

jobs:
  sync-issues:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Detect changed files
        id: diff
        run: |
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} > /tmp/changed.txt
          echo "changed<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/changed.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          cat /tmp/changed.txt

      - name: Compute translation targets
        run: |
          python3 scripts/get-translate-target.py --json --out-file /tmp/targets.json
          cat /tmp/targets.json

      - name: Create issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changed = fs.readFileSync('/tmp/changed.txt', 'utf8').trim().split('\n').filter(Boolean);
            const data = JSON.parse(fs.readFileSync('/tmp/targets.json', 'utf8'));

            const missing = data.missing || [];
            const outdated = data.outdated || [];
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const shortSha = context.sha.substring(0, 7);

            const upstreamChanged = changed.some(p => p.startsWith('upstream/'));
            const localChanged = changed.some(p => !p.startsWith('upstream/'));

            async function issueExistsByTitle(title) {
              const q = `repo:${owner}/${repo} is:issue is:open in:title "${title}"`;
              const res = await github.rest.search.issuesAndPullRequests({ q });
              return res.data.total_count > 0;
            }

            async function createIssue(title, body, labels) {
              await github.rest.issues.create({ owner, repo, title, body, labels });
            }

            // 1) target やその他こちら側の更新がトリガー: 1:1で issue を作成
            if (localChanged) {
              const individualTargets = Array.from(new Set([...missing, ...outdated]));
              if (individualTargets.length > 0) {
                for (const path of individualTargets) {
                  const title = path; // パス表記
                  if (await issueExistsByTitle(title)) continue;

                  const body = [
                    "翻訳対象:",
                    `- \`${path}\``,
                  ].join("\n");

                  await createIssue(title, body, ["new-doc", "ai"]);
                }
              }
              else console.log("No translation targets to create individual issues.");
            }
            // 2) upstream の更新がトリガー（upstreamのみ変更）: まとめて1 issue を作成
            else if (upstreamChanged) {
              const groupedTargets = Array.from(new Set([...missing, ...outdated]));
              if (groupedTargets.length > 0) {
                const title = `Update upstream: ${shortSha}`;
                if (!(await issueExistsByTitle(title))) {
                  const lines = [];
                  lines.push("翻訳対象（更新）:");
                  for (const p of groupedTargets) lines.push(`- \`${p}\``);

                  await createIssue(title, lines.join("\n"), ["update", "ai"]);
                }
              }
              else console.log("No translation targets to update.");
            }
            else {
              console.log("No relevant trigger for issue creation.");
            }
